@page "/ManageTaskList"
@rendermode InteractiveServer
@inject IHttpClientFactory ClientFactory
@inject NavigationManager NavigationManager
@using AP.BTP.UI.Components.Layout
@using System.Net.Http.Json
@using AP.BTP.Application.CQRS.TaskLists
@using AP.BTP.Application.CQRS.Users
@using System.Globalization
@using AP.BTP.Application.CQRS.NurserySites

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <div class="fw-semibold">Beheer Takenlijsten</div>
            <small class="text-muted">Bekijk en beheer bestaande takenlijsten</small>
        </div>
        <div class="d-flex align-items-center gap-2">
            <select class="form-select form-select-sm w-auto" value="@archiveFilter" @onchange="OnArchiveFilterChanged">
                <option value="false">Niet gearchiveerd</option>
                <option value="true">Gearchiveerd</option>
            </select>
            <select class="form-select form-select-sm w-auto" value="@selectedUserIdString" @onchange="OnUserFilterChanged">
                <option value="">Alle medewerkers</option>
                @if (employees != null)
                {
                    foreach (var emp in employees)
                    {
                        <option value="@emp.Id">@emp.Email</option>
                    }
                }
            </select>
            <input type="date" class="form-control form-control-sm w-auto" value="@GetDateInputValue(startDate)" @onchange="OnStartDateChanged" />
            <input type="date" class="form-control form-control-sm w-auto" value="@GetDateInputValue(endDate)" @onchange="OnEndDateChanged" />
            <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="ClearFilters">Wis filters</button>
            <button type="button" class="btn btp-primary" @onclick="GoToAddTasklist">
                <span class="bi bi-plus-lg"></span> Nieuwe Takenlijst
            </button>
        </div>
    </div>

    <!-- Takenlijsten Tabel -->
    <div class="card shadow-sm border-0 slidein-animation">
        <div class="card-body p-0">
            @if (taskLists == null)
            {
                <div class="p-4 text-center text-muted">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    Takenlijsten laden...
                </div>
            }
            else if (!taskLists.Any())
            {
                <div class="p-4 text-center text-muted">
                    <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                    Geen takenlijsten gevonden.
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead class="table-light border-bottom border-1">
                            <tr>
                                <th class="ps-4">#</th>
                                <th>Datum</th>
                                <th>Starttijd</th>
                                <th>Status</th>
                                <th>Zone</th>
                                <th>Kweeksite</th>
                                <th>Aantal taken</th>
                                <th>Medewerker</th>
                                <th class="text-end pe-3">Acties</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var taskList in taskLists)
                            {
                                <tr class="border-bottom">
                                    <td class="ps-3 text-muted">@taskList.Id</td>
                                    <td class="fw-semibold">@taskList.Date.ToString("ddd dd MMM yyyy")</td>
                                    <td>@GetFirstTaskStartTime(taskList)</td>
                                    <td>@RenderStatus(taskList)</td>
                                    <td>@GetZoneCode(taskList.ZoneId)</td>
                                    <td>@GetNurserySiteName(taskList.ZoneId)</td>
                                    <td>
                                        <span class="px-3 py-2">
                                            @taskList.Tasks.Count()
                                        </span>
                                    </td>
                                    @if (taskList.UserId != null)
                                    {
                                        <td>@userEmails[taskList.UserId.Value]</td>
                                    }else
                                    {
                                        <td>-</td>
                                    }
                                    <td class="text-end pe-3">
                                        <button class="btn btn-sm" title="Edit" @onclick="() => GoToEditTaskList(taskList.Id)">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-link text-danger p-0" @onclick="() => ArchiveTaskList(taskList.Id)">
                                            <span class="bi bi-archive"></span>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-end align-items-center p-3 border-top bg-light">
                    <button class="btn btn-outline-secondary me-2" @onclick="PreviousPage" disabled="@(pageNr == 1)">
                        <i class="bi bi-chevron-left"></i> Vorige
                    </button>
                    <span class="mx-2 text-muted small">Pagina @pageNr van @totalPages</span>
                    <button class="btn btn-outline-secondary" @onclick="NextPage" disabled="@(pageNr == totalPages)">
                        Volgende <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private IEnumerable<TaskListDTO> taskLists;
    private int pageNr = 1;
    private int pageSize = 10;
    private int totalTaskLists;
    private int totalPages => (int)Math.Ceiling((double)totalTaskLists / pageSize);
    private string archiveFilter = "false";
    private Dictionary<int, string> userEmails = new();
    private Dictionary<int, string> zoneCodes = new();
    private Dictionary<int, int> zoneNurserySites = new();
    private Dictionary<int, string> nurserySiteNames = new();
    private Popup archiveModal;
    private int? pendingArchiveId;
    private string archiveError = string.Empty;
    private IEnumerable<UserDTO> employees = Enumerable.Empty<UserDTO>();
    private int? selectedUserId;
    private string selectedUserIdString = string.Empty;
    private DateTime? startDate;
    private DateTime? endDate;

    protected override async Task OnInitializedAsync()
    {
        await LoadEmployees();
        await LoadTaskLists();
        await SetUserEmails(taskLists);
        await LoadZoneAndSiteInfo(taskLists);
    }

    private async Task LoadTaskLists()
    {
        var client = ClientFactory.CreateClient("API");
        try
        {
            var noAdvancedFilters = !selectedUserId.HasValue && !startDate.HasValue && !endDate.HasValue;
            if (noAdvancedFilters)
            {
                totalTaskLists = await client.GetFromJsonAsync<int>($"api/v1/TaskList/count?isArchived={archiveFilter}");
                taskLists = await client.GetFromJsonAsync<IEnumerable<TaskListDTO>>($"api/v1/TaskList?pageNr={pageNr}&pageSize={pageSize}&isArchived={archiveFilter}");
                return;
            }

            IEnumerable<TaskListDTO> lists = Enumerable.Empty<TaskListDTO>();
            if (selectedUserId.HasValue && startDate.HasValue && endDate.HasValue)
            {
                var s = startDate.Value.ToString("yyyy-MM-dd");
                var e = endDate.Value.ToString("yyyy-MM-dd");
                lists = await client.GetFromJsonAsync<IEnumerable<TaskListDTO>>($"api/v1/TaskList/userdaterange?userId={selectedUserId.Value}&start={s}&end={e}");
            }
            else if (selectedUserId.HasValue && !startDate.HasValue && !endDate.HasValue)
            {
                lists = await client.GetFromJsonAsync<IEnumerable<TaskListDTO>>($"api/v1/TaskList/user/{selectedUserId.Value}");
            }
            else if (!selectedUserId.HasValue && startDate.HasValue && endDate.HasValue)
            {
                var s = startDate.Value.ToString("yyyy-MM-dd");
                var e = endDate.Value.ToString("yyyy-MM-dd");
                lists = await client.GetFromJsonAsync<IEnumerable<TaskListDTO>>($"api/v1/TaskList/date?start={s}&end={e}");
            }
            else
            {
                if (selectedUserId.HasValue)
                {
                    lists = await client.GetFromJsonAsync<IEnumerable<TaskListDTO>>($"api/v1/TaskList/user/{selectedUserId.Value}");
                }
                else
                {
                    var d = startDate ?? endDate;
                    if (d.HasValue)
                    {
                        var single = d.Value.ToString("yyyy-MM-dd");
                        lists = await client.GetFromJsonAsync<IEnumerable<TaskListDTO>>($"api/v1/TaskList/date?start={single}&end={single}");
                    }
                }
            }

            var filtered = lists;
            if (archiveFilter == "true") filtered = filtered.Where(tl => tl.IsArchived);
            else if (archiveFilter == "false") filtered = filtered.Where(tl => !tl.IsArchived);
            if (selectedUserId.HasValue) filtered = filtered.Where(tl => tl.UserId == selectedUserId.Value);
            if (startDate.HasValue || endDate.HasValue)
            {
                var sDate = startDate ?? DateTime.MinValue;
                var eDate = endDate ?? DateTime.MaxValue;
                filtered = filtered.Where(tl => tl.Date >= sDate && tl.Date <= eDate);
            }
            var result = filtered.ToList();
            totalTaskLists = result.Count;
            taskLists = result.Skip((pageNr - 1) * pageSize).Take(pageSize).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            taskLists = Enumerable.Empty<TaskListDTO>();
            totalTaskLists = 0;
        }
    }

    private async Task OnArchiveFilterChanged(ChangeEventArgs args)
    {
        archiveFilter = args?.Value?.ToString() ?? "false";
        pageNr = 1;
        await LoadTaskLists();
        await SetUserEmails(taskLists);
        await LoadZoneAndSiteInfo(taskLists);
    }

    private async Task OnUserFilterChanged(ChangeEventArgs args)
    {
        selectedUserIdString = args?.Value?.ToString() ?? string.Empty;
        if (int.TryParse(selectedUserIdString, out var id)) selectedUserId = id; else selectedUserId = null;
        pageNr = 1;
        await LoadTaskLists();
        await SetUserEmails(taskLists);
        await LoadZoneAndSiteInfo(taskLists);
    }

    private string GetDateInputValue(DateTime? dt)
    {
        return dt.HasValue ? dt.Value.ToString("yyyy-MM-dd") : string.Empty;
    }

    private async Task OnStartDateChanged(ChangeEventArgs args)
    {
        var v = args?.Value?.ToString();
        if (!string.IsNullOrWhiteSpace(v) && DateTime.TryParseExact(v, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out var d)) startDate = d; else startDate = null;
        pageNr = 1;
        await LoadTaskLists();
        await SetUserEmails(taskLists);
        await LoadZoneAndSiteInfo(taskLists);
    }

    private async Task OnEndDateChanged(ChangeEventArgs args)
    {
        var v = args?.Value?.ToString();
        if (!string.IsNullOrWhiteSpace(v) && DateTime.TryParseExact(v, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out var d)) endDate = d; else endDate = null;
        pageNr = 1;
        await LoadTaskLists();
        await SetUserEmails(taskLists);
        await LoadZoneAndSiteInfo(taskLists);
    }

    private async Task ClearFilters()
    {
        selectedUserId = null;
        selectedUserIdString = string.Empty;
        startDate = null;
        endDate = null;
        pageNr = 1;
        await LoadTaskLists();
        await SetUserEmails(taskLists);
        await LoadZoneAndSiteInfo(taskLists);
    }

    private async Task SetUserEmails(IEnumerable<TaskListDTO> taskLists)
    {
        foreach (var taskList in taskLists)
        {
            if (taskList.UserId != null)
            {
                userEmails[taskList.UserId.Value] = await LoadUser(taskList.UserId);
            }
        }
    }

    private async Task LoadZoneAndSiteInfo(IEnumerable<TaskListDTO> lists)
    {
        zoneCodes.Clear();
        zoneNurserySites.Clear();

        var zoneIds = lists.Where(tl => tl.ZoneId.HasValue).Select(tl => tl.ZoneId.Value).Distinct().ToList();
        if (zoneIds.Count == 0) return;

        var client = ClientFactory.CreateClient("API");
        try
        {
            var zones = await client.GetFromJsonAsync<IEnumerable<ZoneDTO>>("api/v1/zone?pageNr=1&pageSize=1000");
            if (zones != null)
            {
                foreach (var z in zones.Where(z => zoneIds.Contains(z.Id)))
                {
                    zoneCodes[z.Id] = z.Code;
                    zoneNurserySites[z.Id] = z.NurserySiteId;
                }
            }

            var siteIds = zoneNurserySites.Values.Distinct().ToList();
            if (siteIds.Any())
            {
                var sites = await client.GetFromJsonAsync<IEnumerable<NurserySiteDTO>>("api/v1/nurserysite?pageNr=1&pageSize=1000");
                if (sites != null)
                {
                    foreach (var site in sites.Where(s => siteIds.Contains(s.Id)))
                        nurserySiteNames[site.Id] = site.Name;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fout bij laden zone/kweeksite info: {ex.Message}");
        }
    }

    private async Task<string> LoadUser(int? userId)
    {
        var client = ClientFactory.CreateClient("API");
        var user = await client.GetFromJsonAsync<UserDTO>($"api/v1/user/{userId}");
        if (user == null) return "Gebruiker kon niet opgehaald worden";
        return user.Email;
    }

    private async Task NextPage()
    {
        if (pageNr < totalPages)
        {
            pageNr++;
            await LoadTaskLists();
            await LoadZoneAndSiteInfo(taskLists);
            await SetUserEmails(taskLists);
        }
    }

    private async Task PreviousPage()
    {
        if (pageNr > 1)
        {
            pageNr--;
            await LoadTaskLists();
            await LoadZoneAndSiteInfo(taskLists);
            await SetUserEmails(taskLists);
        }
    }

    private string GetFirstTaskStartTime(TaskListDTO taskList)
    {
        var firstTask = taskList.Tasks.OrderBy(t => t.PlannedStartTime).FirstOrDefault();
        return firstTask?.PlannedStartTime.ToString("HH:mm") ?? "-";
    }

    private MarkupString RenderStatus(TaskListDTO taskList)
    {
        if (taskList.IsArchived)
        {
            return (MarkupString)"<span class=\"badge bg-secondary\">Klaar</span>";
        }

        var hasProgress = taskList.Tasks.Any(t => t.StartTime != null || t.StopTime != null);
        if (hasProgress)
            return (MarkupString)"<span class=\"badge bg-warning text-dark\">Bezig</span>";

        return (MarkupString)"<span class=\"badge bg-success\">Te doen</span>";
    }

    private string GetZoneCode(int? zoneId)
    {
        if (zoneId.HasValue && zoneCodes.TryGetValue(zoneId.Value, out var code))
            return code;
        return "-";
    }

    private string GetNurserySiteName(int? zoneId)
    {
        if (zoneId.HasValue && zoneNurserySites.TryGetValue(zoneId.Value, out var siteId))
        {
            if (nurserySiteNames.TryGetValue(siteId, out var name))
                return name;
        }
        return "-";
    }

    private void GoToAddTasklist()
    {
        NavigationManager.NavigateTo("/AddTaskList");
    }

    private void GoToEditTaskList(int id)
    {
        NavigationManager.NavigateTo($"/EditTaskList/{id}");
    }

    private async Task LoadEmployees()
    {
        var client = ClientFactory.CreateClient("API");
        try
        {
            employees = await client.GetFromJsonAsync<IEnumerable<UserDTO>>("api/v1/User/byrole?role=Medewerker&pageNr=1&pageSize=1000");
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            employees = Enumerable.Empty<UserDTO>();
        }
    }

    private async Task ArchiveTaskList(int id)
    {
        pendingArchiveId = id;
        archiveError = string.Empty;
        if (archiveModal != null)
            await archiveModal.ShowAsync();
    }

    private async Task ConfirmArchive()
    {
        if (!pendingArchiveId.HasValue) return;
        var client = ClientFactory.CreateClient("API");
        try
        {
            var response = await client.PutAsync($"api/v1/TaskList/{pendingArchiveId.Value}/archive", null);
            if (response.IsSuccessStatusCode)
            {
                await CloseArchiveModal();
                await LoadTaskLists();
                await SetUserEmails(taskLists);
                return;
            }

            var fallback = "Archiveren mislukt.";
            try
            {
                var apiResult = await response.Content.ReadFromJsonAsync<ApiResult>();
                if (!string.IsNullOrWhiteSpace(apiResult?.Message)) fallback = apiResult.Message;
            }
            catch
            {
                var raw = await response.Content.ReadAsStringAsync();
                if (!string.IsNullOrWhiteSpace(raw)) fallback = raw;
            }

            archiveError = fallback;
        }
        catch (Exception ex)
        {
            archiveError = $"Archiveren mislukt: {ex.Message}";
        }
    }

    private async Task CloseArchiveModal()
    {
        pendingArchiveId = null;
        archiveError = string.Empty;
        if (archiveModal != null)
            await archiveModal.HideAsync();
    }

    private class ApiResult
    {
        public bool Succeeded { get; set; }
        public string Message { get; set; }
    }
}

<Popup @ref="archiveModal"
       Title="Takenlijst archiveren"
       IsVerticallyCentered="true"
       Size="ModalSize.Regular">
    <BodyTemplate>
        <p class="mb-2">Weet je zeker dat je deze takenlijst wilt archiveren?</p>
        @if (!string.IsNullOrWhiteSpace(archiveError))
        {
            <div class="alert alert-danger mt-2" role="alert">@archiveError</div>
        }
    </BodyTemplate>
    <FooterTemplate>
        <button class="btn btn-secondary me-2" @onclick="CloseArchiveModal">Annuleren</button>
        <button class="btn btn-danger" @onclick="ConfirmArchive">Archiveren</button>
    </FooterTemplate>
</Popup>
