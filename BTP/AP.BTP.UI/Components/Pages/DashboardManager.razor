@rendermode InteractiveServer
@inject IHttpClientFactory ClientFactory
@inject NavigationManager Navigation
@using System.Net
@using System.Net.Http.Json
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using AP.BTP.Application.CQRS.Users

<div class="dashboard-container">
    <!-- Welcome Header -->
    <div class="dashboard-header">
        <div class="slidein-animation2 welcome-content">
            <h1 class="dashboard-title">Welkom2 @displayName bij het Dashboard</h1>
            <p class="dashboard-subtitle">Overzicht van verantwoordelijke statistieken</p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid slidein-animation">
        <!-- Users Card -->
        <div class="stat-card stat-card-users clickable" @onclick="GoToUserList">
            <div class="stat-card-content">
                <div class="stat-icon-wrapper stat-icon-users">
                    <i class="bi bi-people-fill stat-icon"></i>
                </div>
                <div class="stat-info">
                    <h3 class="stat-label">Gebruikers</h3>
                    @if (isLoading)
                    {
                        <div class="stat-loading">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            <span>Laden...</span>
                        </div>
                    }
                    else
                    {
                        <div class="stat-value">@userCount</div>
                        <p class="stat-description">Totaal aantal geregistreerde gebruikers</p>
                    }
                </div>
            </div>
            <div class="stat-card-decoration"></div>
        </div>

        <!-- TaskLists Card -->
        <div class="stat-card stat-card-tasklists clickable" @onclick="GoToTaskLists">
            <div class="stat-card-content">
                <div class="stat-icon-wrapper stat-icon-tasklists">
                    <i class="bi bi-list-check stat-icon"></i>
                </div>
                <div class="stat-info">
                    <h3 class="stat-label">Takenlijsten</h3>
                    @if (isLoading)
                    {
                        <div class="stat-loading">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            <span>Laden...</span>
                        </div>
                    }
                    else
                    {
                        <div class="stat-value">@taskListCount</div>
                        <p class="stat-description">Totaal aantal takenlijsten</p>
                    }
                </div>
            </div>
            <div class="stat-card-decoration"></div>
        </div>
    </div>
</div>

@code {
    private int userCount = 0;
    private int taskListCount = 0;
    private bool isLoading = true;
    private string displayName = string.Empty;

    private UserDTO? user;

    private async Task LoadCurrentUser()
    {
        var client = ClientFactory.CreateClient("API");
        try
        {
            var response = await client.GetAsync("api/v1/User/me");
            if (response.StatusCode == HttpStatusCode.NotFound)
            {
                displayName = "Manager";
                user = null;
                return;
            }

            response.EnsureSuccessStatusCode();
            user = await response.Content.ReadFromJsonAsync<UserDTO>();
            var nameCandidate = $"{user?.FirstName} {user?.LastName}".Trim();
            displayName = string.IsNullOrWhiteSpace(nameCandidate)
                ? (user?.Email ?? "Manager")
                : nameCandidate;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Kon huidige gebruiker niet laden: {ex.Message}");
            displayName = "Manager";
        }
    }



    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUser();
        await LoadStatistics();
    }

    private async Task LoadStatistics()
    {
        isLoading = true;
        var client = ClientFactory.CreateClient("API");

        try
        {
            // Load user count
            userCount = await client.GetFromJsonAsync<int>("api/v1/User/count");

            // Load tasklist count
            taskListCount = await client.GetFromJsonAsync<int>("api/v1/TaskList/count");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fout bij laden statistieken: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoToUserList()
    {
        Navigation.NavigateTo("/UserList");
    }

    private void GoToTaskLists()
    {
        Navigation.NavigateTo("/ManageTaskList");
    }
}
